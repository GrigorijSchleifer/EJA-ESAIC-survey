---
title: "EJA-paper"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r libraries}
library(tableone)
library(RColorBrewer)
library(scales)
library(lessR)
library(xlsx)
library(ggpubr)
library(scales)

# library(ReporteRs)
# library(magrittr)
```
```{r import and load files}
# survey_data <- read_csv("data/survey_data_no_other.csv")
# survey_data_all_countries <- read_csv("data/survey_data_all_countries.csv")
# survey_fragments <- read_csv("data/survey_fragments.csv")
# 
# save("all_questions", "all_questions_list", "BIP_DF", "high_gdp_countries", "intermediate_EU_member", "low_gdp_countries", "middle_gdp_countries", "original_EU_member", "post_mill_eu_member", "questions_table_one_EJA_paper", "survey_data", "survey_data_all_countries", "survey_fragments", file = "Rfiles.RData")

load("Rfiles.RData")

# change "Country where you work?" to "country" for later BIP and EU membership code
names(survey_data)[12] <- "country"
```


```{r Create GDP and EU membership columns}
survey_data <- survey_data %>% 
    mutate(EU_members = case_when(
        country %in% original_EU_member ~ "Original",
        country %in% intermediate_EU_member ~ "Intermediate",
        country %in% post_mill_eu_member ~ "Postmillenial",
        TRUE ~ "NO MEMBER")) 

# https://tradingeconomics.com/country-list/gdp?continent=europe
BIP_DF <- BIP_DF %>% 
    mutate(levels_bip = cut(BIP_DF$BIP, 
                            breaks = c(1, 100, 500, Inf), 
                            labels = c("Low", "Middle", "High")))

survey_data <- survey_data %>% 
    mutate(GDP = case_when(
        country %in% high_gdp_countries ~ "High GDP",
        country %in% middle_gdp_countries ~ "Middle GDP",
        country %in% low_gdp_countries ~ "Low GDP",
        TRUE ~ "NO MEMBER")) 
```

```{r Table One FIRST PUBLICATION}
# https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html
# stratification by gender
catVars = "Gender"

contVars = c(
    "Profession",
    "Your expert level"
)
# cava NA's for stratification is not possible since NA is dropped
tableOne <-
    CreateTableOne(
        data = survey_data,
        vars = contVars,
        # testExact = fisher.test,     
        addOverall = FALSE,
        strata = catVars
    )


results_tbl <- print(tableOne, nonnormal = biomarkers, exact = "stage", quote = FALSE, noSpaces = FALSE, printToggle = FALSE)
summary(tableOne)
# writing the table to excel
# write.xlsx(results_tbl,
#            file = "~/Desktop/R/Shiny/ESAIC-survey/ESAIC-KAI-survey-2021/master_data.xlsx",
#            sheetName = "demographics_paper_gender_fix", 
#            col.names = TRUE, 
#            row.names = TRUE, 
#            append = TRUE)
```
```{r Table One Stratified EU member}
# https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html
# stratification by gender

catVars = "EU_members"

contVars =  questions_table_one_EJA_paper

# cava NA's for stratification is not possible since NA is dropped
tableOne <-
    CreateTableOne(
        data = survey_data,
        vars = contVars,
        testExact = fisher.test,     
        addOverall = FALSE,
        strata = catVars
    )


results_tbl <- print(tableOne, nonnormal = biomarkers, exact = "stage", quote = FALSE, noSpaces = FALSE, printToggle = FALSE)

# writing the table to excel
write.xlsx(results_tbl,
           file = "~/Desktop/R/EJA-ESAIC-survey/tbl_one.xlsx",
           sheetName = "table_one_EU_countries",
           col.names = TRUE,
           row.names = TRUE)
```
```{r Table One GDP Stratified}
# https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4966396/
# https://www.socscistatistics.com/tests/chisquare2/default2.aspx
# https://www.youtube.com/watch?v=f53nXHoMXx4&t=42s&ab_channel=VectorsAcademy

# stratification by GDP
catVars = "GDP"

contVars = questions_table_one_EJA_paper

survey_data <- survey_data %>% 
    dplyr::filter(GDP != "NO MEMBER")

# cava NA's for stratification is not possible since NA is dropped
tableOne <-
    CreateCatTable(
        data = survey_data,
        vars = contVars,
        # testExact = fisher.test,     
        addOverall = FALSE,
        strata = catVars
    )


results_tbl <- print(tableOne, nonnormal = biomarkers, exact = "stage", quote = FALSE, noSpaces = FALSE, printToggle = FALSE)

# writing the table to excel
write.xlsx(results_tbl,
           file = "~/Desktop/R/EJA-ESAIC-survey/tbl_one_test.xlsx",
           sheetName = "GDP stratified two",
           col.names = TRUE,
           row.names = TRUE)
```

```{r responce counts for different countries}
survey_fragments %>% 
    dplyr::filter(country != "Other") %>% 
    count(country) %>% 
    arrange(desc(n)) %>% 
    print(n = 100)
```
```{r Who obtaines consent?}
survey_fragments %>% 
    count(who.obtains) %>% 
    dplyr::filter(!is.na(who.obtains)) %>% 
    mutate(who.obtains = fct_reorder(who.obtains, n)) %>% 
    ggplot(aes(x = who.obtains, y = n, fill = who.obtains)) +
            geom_col() +
            labs(x = "", 
                 y = "", 
                 title = "Who in general obtains the informed consent?") +
            theme_light(base_size = 15) + 
            theme(title = element_text(size = 25, colour = 'black'),
                  axis.text.x = element_text(size = 22, vjust = 1.3),
                  axis.text.y = element_text(size = 20)) +
            theme(legend.position = "None") +
            scale_fill_brewer(palette = "Set2") +
    coord_flip()
```
```{r data provided by}
table(survey_data$Profession)
prop.table(table(survey_data$Profession))
```
```{r risc scores}
survey_fragments %>% 
    select(ASA.Class:POSPOM) %>% 
    # using dplyrs across function to perform columnwise operations on character data
    summarise(across(is.character, table)) %>% 
    .[2,] %>% 
    gather(risk_score, value) %>% 
    mutate(risk_score = fct_reorder(risk_score, value)) %>% 
    ggplot(aes(x = risk_score, y = value, fill = risk_score)) +
    geom_bar(stat='identity') +
    labs(x = "", 
                 y = "", 
                 title = "Risk scores used") +
            theme_light(base_size = 15) + 
            theme(title = element_text(size = 25, colour = 'black'),
                  axis.text.x = element_text(size = 22, vjust = 1.3),
                  axis.text.y = element_text(size = 20)) +
            theme(legend.position = "None") +
            scale_fill_brewer(palette = "Set2") +
    coord_flip()
```
```{r questionnaire table}
catVars = "Gender"

contVars = c(
    "Profession",
    "Your expert level"
)
# cava NA's for stratification is not possible since NA is dropped
tableOne <-
    CreateTableOne(
        data = survey_data,
        vars = contVars,
        testExact = fisher.test,     
        addOverall = FALSE,
        strata = catVars
    )


results_tbl <- print(tableOne, nonnormal = biomarkers, exact = "stage", quote = FALSE, noSpaces = FALSE, printToggle = FALSE)
summary(tableOne)

```
```{r PIE When do you need to obtain Informed consent for elective surgery based on legal requirements?}
prop.table(table(survey_data$"When do you need to obtain Informed consent for elective surgery based on legal requirements (for simple procedures, low risk patients)."))
prop.table(table(survey_data$"When do you need to obtain Informed consent for elective surgery based on legal requirements (for complex procedures, higher risk patients)."))

# 24 h prior and 24 prior because of daily routine pooled together
simple_df <- data.frame(simple_complex = c(rep("simple procedures", 3), rep("complex procedures", 3)),
                        answer = rep(c("2 days or more", "24h or less", "Same day"), 2),
                        when_simple = round(c(0.1289111, 0.5419274, 0.3291615, 0.33625, 0.51625, 0.14750), digits = 3) * 100)


# "#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF"
simple_df %>% 
    ggplot(aes(x="", y=when_simple, fill=answer)) +
    geom_bar(stat="identity", width=1, color = "white") +
    coord_polar("y", start=0) + 
    theme_void() + 
    geom_text(aes(label = paste0(when_simple, "%")),
              size = 10, 
              colour="white",
              position = position_stack(vjust = 0.5)) +
    theme(legend.position="bottom",
          legend.title = element_blank(),
          legend.text = element_text(size=30),
          legend.spacing.x = unit(1.5, 'cm'),
          strip.text.x = element_text(size=35)) +
    # "#00441B", "#053060", "#660A1F", "#A7771C" (Dunkel)
    # "#4B72AF", "#54A968", "#C64E51", "#DCAD94" (etwas weniger knallig)
    scale_fill_manual(values=c("#B2172B", "#08598D", "#1E9D77", "#A7771C")) + 
    facet_wrap(~factor(simple_complex, levels = c("simple procedures", "complex procedures")))



################## base R pie ####################################
# when_obtain_simple_complex <- c("2 days or more",
#                         "24h or less",
#                         "Same day")
# 
# when_simple <- round(c(0.1289111, 0.5419274, 0.3291615), digits = 2) * 100
# when_complex <- round(c(0.33625, 0.51625, 0.14750), digits = 2) * 100
# 
# cols = brewer.pal(n = length(when_obtain_simple_complex), name = 'Set1')
# par(mfrow = c(1, 2))
# 
# # prop.table(table(survey_data$"When do you need to obtain Informed consent for elective surgery based on legal requirements (for simple procedures, low risk patients)."))
# pie(when_simple, 
#     labels = paste0(when_simple, "%"),
#     clockwise = TRUE,
#     col = cols,
#     cex.main=3, 
#     cex = 2.5,
#     main = "simple procedures",
#     radius = 1.2,
#     border = "white")
# 
# legend("bottom", 
#        legend = when_obtain_simple_complex,
#        fill = cols,
#        cex = 1.5, 
#        bty = "n",
#        border = "white",
#        inset = -.06)
# 
# # prop.table(table(survey_data$"When do you need to obtain Informed consent for elective surgery based on legal requirements (for complex procedures, higher risk patients)."))
# pie(when_complex,
#     labels = paste0(when_complex, "%"),
#     clockwise = TRUE,
#     cex.main=3, 
#     cex = 2.5,
#     col = cols,
#     main = "complex procedures",
#     radius = 1.2,
#     border = "white")
```
```{r PIE Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? }
prop.table(table(survey_data$"Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for simple procedures, low risk patients)"))
table(survey_data$"Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for simple procedures, low risk patients)")

prop.table(table(survey_data$"Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for complex procedures, higher risk patients)"))
table(survey_data$"Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for complex procedures, higher risk patients)")


consent_legal <- data.frame(simple_complex = c(rep("simple procedures", 3), rep("complex procedures", 3)),
                        answer = rep(c("Unsure", "No", "Yes"), 2),
                        when_simple = round(c(0.3553616, 0.3715711, 0.2730673, 0.3877805, 0.4251870, 0.1870324), digits = 3) * 100)


consent_legal %>% 
    ggplot(aes(x="", y=when_simple, fill=answer)) +
    geom_bar(stat="identity", width=1, color = "white") +
    coord_polar("y", start=0) + 
    theme_void() + 
    geom_text(aes(label = paste0(when_simple, "%")),
              size = 10, 
              colour="white",
              position = position_stack(vjust = 0.5)) +
    theme(legend.position="bottom",
          legend.title = element_blank(),
          legend.text = element_text(size=30),
          legend.spacing.x = unit(1.5, 'cm'),
          strip.text.x = element_text(size=35)) +
    # "#00441B", "#053060", "#660A1F", "#A7771C" (Dunkel)
    # "#4B72AF", "#54A968", "#C64E51", "#DCAD94" (etwas weniger knallig)
    # "#B2172B", "#08598D", "#1E9D77", "#A7771C" (original)
    # "#ffffb2", "#fecc5c", "#fd8d3c", "#e31a1c" (black and white compatible)
    scale_fill_manual(values=c("#B2172B", "#08598D", "#1E9D77", "#A7771C")) +
    facet_wrap(~factor(simple_complex, levels = c("simple procedures", "complex procedures")))
```
```{r Thinking of Re-Do / repeated anaesthesia assuming the patient is well informed. Would an online/telephone informed consent then be allowed for elective surgery due to legal requirements in your country?}

prop.table(table(survey_data$`Thinking of Re-Do / repeated anaesthesia assuming the patient is well informed. Would an online/telephone informed consent then be allowed for elective surgery due to legal requirements in your country?`))

redo_legal <- data.frame(answer = c("Unsure", "No", "Yes"),
                        when_simple = round(c(0.3496241, 0.3283208, 0.3220551), digits = 3) * 100)


redo_legal %>% 
    ggplot(aes(x="", y=when_simple, fill=answer)) +
    geom_bar(stat="identity", width=1, color = "white") +
    coord_polar("y", start=0) + 
    theme_void() + 
    geom_text(aes(label = paste0(when_simple, "%")),
              size = 10, 
              colour="white",
              position = position_stack(vjust = 0.5)) +
    theme(legend.position="bottom",
          legend.title = element_blank(),
          legend.text = element_text(size=30),
          legend.spacing.x = unit(1.5, 'cm'),
          strip.text.x = element_text(size=35)) +
    # "#00441B", "#053060", "#660A1F", "#A7771C" (Dunkel)
    # "#4B72AF", "#54A968", "#C64E51", "#DCAD94" (etwas weniger knallig)
    # "#B2172B", "#08598D", "#1E9D77", "#A7771C" (original)
    # "#ffffb2", "#fecc5c", "#fd8d3c", "#e31a1c" (black and white compatible)
    scale_fill_manual(values=c("#B2172B", "#08598D", "#1E9D77", "#A7771C"))
```

```{r R files used for analysis}
# storing all column names as a list of characters
all_questions <- dput(names(survey_data)) 

original_EU_member <- c("Belgium",
              "France",
              "Germany",
              "Italy",
              "Luxemburg",
              "Netherlands")

intermediate_EU_member <- c("Austria",
                     "Denmark",
                     "Finland",
                     "Greece",
                     "Ireland",
                     "Portugal",
                     "Spain",
                     "Sweden")

post_mill_eu_member <- c("Bulgaria",
                  "Croatia",
                  "Cyprus",
                  "Czechia",
                  "Estonia",
                  "Hungary",
                  "Latvia",
                  "Lithuania",
                  "Malta",
                  "Poland",
                  "Romania",
                  "Slovakia",
                  "Slovenia")

high_gdp_countries <- c(
    "Germany",
    "United Kingdom (UK)",
    "France",
    "Italy",
    "Russia",
    "Spain",
    "Netherlands",
    "Switzerland",
    "Turkey",
    "Poland",
    "Sweden",
    "Belgium"
)

middle_gdp_countries <- c(
    "Austria",
    "Ireland",
    "Norway",
    "Denmark",
    "Finland",
    "Romania",
    "Czechia",
    "Portugal",
    "Greece",
    "Ukraine",
    "Hungary",
    "Slovakia",
    "Israel",
    "Kazakhstan"
)

low_gdp_countries <- c(
    "Luxembourg",
    "Bulgaria",
    "Belarus",
    "Croatia",
    "Lithuania",
    "Slovenia",
    "Serbia",
    "Latvia",
    "Estonia",
    "Cyprus",
    "Iceland",
    "Bosnia and Herzegovina",
    "Albania",
    "Malta",
    "North Macedonia (formerly Macedonia)",
    "Moldova",
    "Monaco",
    "Kosovo",
    "Georgia",
    "Liechtenstein",
    "Uzbekistan"
)

BIP_DF <- tibble(
    country = c(
        "Germany",
        "United Kingdom (UK)",
        "France",
        "Italy",
        "Russia",
        "Spain",
        "Netherlands",
        "Switzerland",
        "Turkey",
        "Poland",
        "Sweden",
        "Belgium",
        "Austria",
        "Ireland",
        "Norway",
        "Denmark",
        "Finland",
        "Romania",
        "Czechia",
        "Portugal",
        "Greece",
        "Ukraine",
        "Hungary",
        "Slovakia",
        "Luxembourg",
        "Bulgaria",
        "Belarus",
        "Croatia",
        "Lithuania",
        "Slovenia",
        "Serbia",
        "Latvia",
        "Estonia",
        "Cyprus",
        "Iceland",
        "Bosnia and Herzegovina",
        "Albania",
        "Malta",
        "North Macedonia (formerly Macedonia)",
        "Moldova",
        "Monaco",
        "Kosovo",
        "Georgia",
        "Israel",
        "Kazakhstan",
        "Liechtenstein",
        "Uzbekistan"
    ),
    BIP = c(
        3846,
        2708,
        2630,
        1886,
        1484,
        1281,
        914,
        752,
        720,
        594,
        541,
        515,
        431,
        426,
        363,
        356,
        270,
        249,
        245,
        231,
        189,
        156,
        155,
        105,
        73.26,
        69.11,
        60.26,
        55.97,
        55.89,
        53.59,
        52.96,
        33.51,
        30.65,
        23.8,
        21.71,
        19.79,
        14.8,
        14.65,
        12.27,
        11.91,
        8,
        7.61,
        15.89,
        402,
        169.8,
        6.69,
        57.7
    )
)

questions_table_one_EJA_paper <- c(
    "How would you prefer to do the anaesthesiological preoperative evaluation in the future?",
    "When do you need to obtain Informed consent for elective surgery based on legal requirements (for complex procedures, higher risk patients).",
    "When do you need to obtain Informed consent for elective surgery based on legal requirements (for simple procedures, low risk patients).",
    "Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for complex procedures, higher risk patients)",
    "Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for simple procedures, low risk patients)",
    "Thinking of Re-Do / repeated anaesthesia assuming the patient is well informed. Would an online/telephone informed consent then be allowed for elective surgery due to legal requirements in your country?",
    "Is there a special regulation in your country during this pandemic situation favouring online or telephone informed consent?",
    "Is it possible to obtain informed consent online via internet, in your routine setting?",
    "Is it possible to obtain informed consent online via telefone, in your routine setting?",
    "Do you know if it is legally allowed to obtain informed consent via Internet or telephone (for simple procedures, low risk patients) in your country?",
    "When ensuring a certain guideline, which may include i.e. specific appointment (time and date) for the interview, secure data protected online service, asking if there is a relaxed environment without distraction, parents’ explicit agreement in online or telephone interview. Would this be an alternative to personal face-to-face meetings?",
    "[Together with special designed written information and professional pre-produced videos it might be more efficient than face-to-face meeting] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
)

# survey_data_barchart$country[survey_data_barchart$country == "United Kingdom (UK)"] <- "UK" 
# survey_data_barchart$country[survey_data_barchart$country == "North Macedonia (formerly Macedonia)"] <- "Macedonia" 
# survey_data_barchart$country[survey_data_barchart$country == "Bosnia and Herzegovina"] <- "B&H" 
```

```{r}
# tibble for GDP per capita
GDP_PC <- tibble(
    countries =
        c(
            "Luxembourg",
            "Ireland",
            "Switzerland",
            "Norway",
            "Denmark",
            "Netherlands",
            "Iceland",
            "Austria",
            "Germany",
            "Sweden",
            "Belgium",
            "Finland",
            "Euro Area",
            "France",
            "United Kingdom",
            "European Union",
            "Malta",
            "Italy",
            "Czech Republic",
            "Cyprus",
            "Lithuania",
            "Slovenia",
            "Spain",
            "Estonia",
            "Poland",
            "Portugal",
            "Hungary",
            "Slovakia",
            "Latvia",
            "Romania",
            "Turkey",
            "Greece",
            "Croatia",
            "Russia",
            "Bulgaria",
            "Belarus",
            "Montenegro",
            "Serbia",
            "Macedonia",
            "Bosnia and Herzegovina",
            "Albania",
            "Ukraine",
            "Moldova",
            "Kosovo"
        ),
    GDP_PC = c(
        110261,
        89689,
        68393,
        63586,
        55938,
        54210,
        52280,
        51936,
        50922,
        50683,
        48210,
        47261,
        43681,
        42026,
        41627,
        41504,
        39222,
        38992,
        38319,
        37655,
        36732,
        36548,
        36215,
        35638,
        32238,
        32181,
        31008,
        30330,
        29932,
        28833,
        28385,
        27287,
        26465,
        26456,
        22384,
        19148,
        18279,
        18210,
        15848,
        14340,
        13295,
        12377,
        12325,
        10776
    )
)


```
