---
title: "EJA-paper"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r libraries}
library(tableone)
library(RColorBrewer)
library(scales)
library(lessR)
library(xlsx)
library(ggpubr)
library(scales)

# library(ReporteRs)
# library(magrittr)
```

```{r All questions separated by LimeSurvey}

"Gender"
"What is your age?"
"Profession"
"Your expert level"
"Years of experience"
"Country where you work?"

"Who in general obtains the informed consent prior to anaesthesia?"

"[ASA-Class] Which of the following Scores do you routinely use in preoperative evaluation?"
"[Apfel-Score] Which of the following Scores do you routinely use in preoperative evaluation?"
"[NYHA-Score] Which of the following Scores do you routinely use in preoperative evaluation?"
"[ARISCAT-Score] Which of the following Scores do you routinely use in preoperative evaluation?" 
"[rCRI] Which of the following Scores do you routinely use in preoperative evaluation?"
"[POSPOM] Which of the following Scores do you routinely use in preoperative evaluation?" 
"[Other] Which of the following Scores do you routinely use in preoperative evaluation?" 
"How would you prefer to do the anaesthesiological preoperative evaluation in the future?" 
"[Other] How would you prefer to do the anaesthesiological preoperative evaluation in the future?"
"When do you need to obtain Informed consent for elective surgery based on legal requirements (for complex procedures, higher risk patients)."
"When do you need to obtain Informed consent for elective surgery based on legal requirements (for simple procedures, low risk patients)."
"Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for complex procedures, higher risk patients)"
"[Comment] Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for complex procedures, higher risk patients)"
"Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for simple procedures, low risk patients)"
"[Comment] Is an online/telephone informed consent for elective surgery in accordance with the legal requirements in your country? (for simple procedures, low risk patients)"
"Thinking of Re-Do / repeated anaesthesia assuming the patient is well informed. Would an online/telephone informed consent then be allowed for elective surgery due to legal requirements in your country?"
"Is there a special regulation in your country during this pandemic situation favouring online or telephone informed consent?"
"Is it possible to obtain informed consent online via internet, in your routine setting?"
"[Comment] Is it possible to obtain informed consent online via internet, in your routine setting?"
"Is it possible to obtain informed consent online via telefone, in your routine setting?"
"[Comment] Is it possible to obtain informed consent online via telefone, in your routine setting?"
"Do you know if it is legally allowed to obtain informed consent via Internet or telephone (for simple procedures, low risk patients) in your country?"
"[Comment] Do you know if it is legally allowed to obtain informed consent via Internet or telephone (for simple procedures, low risk patients) in your country?" 
"When ensuring a certain guideline, which may include i.e. specific appointment (time and date) for the interview, secure data protected online service, asking if there is a relaxed environment without distraction, parents’ explicit agreement in online or telephone interview. Would this be an alternative to personal face-to-face meetings?"
"[Comment] When ensuring a certain guideline, which may include i.e. specific appointment (time and date) for the interview, secure data protected online service, asking if there is a relaxed environment without distraction, parents’ explicit agreement in online or telephone interview. Would this be an alternative to personal face-to-face meetings?"
"[Lack of personal contact] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[Patient´s behaviour is impossible to observe] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[Personal relation with the patient cannot be build] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[Confidence in anaesthesia cannot be achieved] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[Impossible to fulfil legal requirements] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[I am not sure if it might be illegal in my country] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[Impossible to gather for anamnestic information] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[Other] What are your major concerns about online or telephone interviews? (More than one answer is possible)"
"[If patients are from remote locations,  no travel or transportation is necessary] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
"[More relaxed for the patients] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
"[No waste of time waiting in the holding area] What could be a major advantage of online/telephone interviews? (More than one answer is possible)" 
"[Less anger/stress due to long waiting] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
"[With specific questions all information could be obtained] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
"[Together with special designed written information and professional pre-produced videos it might be more efficient than face-to-face meeting] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
"[Other] What could be a major advantage of online/telephone interviews? (More than one answer is possible)"
"Do you need to obtain written Informed consent for elective surgery due to legal requirements from both parents or just from one (complex procedures, higher risk patients)?"
"[Comment] Do you need to obtain written Informed consent for elective surgery due to legal requirements from both parents or just from one (complex procedures, higher risk patients)?"
"Do you need to obtain written Informed consent for elective surgery due to legal requirements from both parents or just from one (simple procedures, low risk patients)?"
"[Comment] Do you need to obtain written Informed consent for elective surgery due to legal requirements from both parents or just from one (simple procedures, low risk patients)?"
"[Age above ...] What requirements does a child have to fulfil to sign independently?"
"[Comment] [Age above ...] What requirements does a child have to fulfil to sign independently?"
"[Having the mental capacity to understand the consequences of its decision] What requirements does a child have to fulfil to sign independently?"
"[Comment] [Having the mental capacity to understand the consequences of its decision] What requirements does a child have to fulfil to sign independently?"
"[other ...] What requirements does a child have to fulfil to sign independently?"
"[Comment] [other ...] What requirements does a child have to fulfil to sign independently?"
"Do you know if it is legally allowed to obtain informed consent from the parent/caregiver via Internet or telephone?"
"[Comment] Do you know if it is legally allowed to obtain informed consent from the parent/caregiver via Internet or telephone?"
"In case of personal presence of the parent/caregiver do you routinely check the identity or legal responsibility of the parent/caregiver (i.e. ID card)"
"[Comment] In case of personal presence of the parent/caregiver do you routinely check the identity or legal responsibility of the parent/caregiver (i.e. ID card)"
"Do you think it is necessary to verify the identity of the parent/guardian  (i.e. ID card)"
"[Comment] Do you think it is necessary to verify the identity of the parent/guardian  (i.e. ID card)"
```

```{r Data import and cleaning}
survey_data <- read_csv("survey_data_no_other.csv")
survey_data_all_countries <- read_csv("survey_data_all_countries.csv")
survey_fragments <- read_csv("survey_fragments.csv")
```

```{r Table One}
# https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html
# stratification by gender
catVars = "Gender"

contVars = c(
    "Profession",
    "Your expert level"
)
# cava NA's for stratification is not possible since NA is dropped
tableOne <-
    CreateTableOne(
        data = survey_data,
        vars = contVars,
        testExact = fisher.test,     
        addOverall = FALSE,
        strata = catVars
    )


results_tbl <- print(tableOne, nonnormal = biomarkers, exact = "stage", quote = FALSE, noSpaces = FALSE, printToggle = FALSE)
summary(tableOne)
# writing the table to excel
# write.xlsx(results_tbl,
#            file = "~/Desktop/R/Shiny/ESAIC-survey/ESAIC-KAI-survey-2021/master_data.xlsx",
#            sheetName = "demographics_paper_gender_fix", 
#            col.names = TRUE, 
#            row.names = TRUE, 
#            append = TRUE)
```

```{r responce counts for different countries}
survey_fragments %>% 
    dplyr::filter(country != "Other") %>% 
    count(country) %>% 
    arrange(desc(n)) %>% 
    print(n = 100)
```


```{r who obtaines consent?}
survey_fragments %>% 
    count(who.obtains) %>% 
    dplyr::filter(!is.na(who.obtains)) %>% 
    mutate(who.obtains = fct_reorder(who.obtains, n)) %>% 
    ggplot(aes(x = who.obtains, y = n, fill = who.obtains)) +
            geom_col() +
            labs(x = "", 
                 y = "", 
                 title = "Who in general obtains the informed consent?") +
            theme_light(base_size = 15) + 
            theme(title = element_text(size = 25, colour = 'black'),
                  axis.text.x = element_text(size = 22, vjust = 1.3),
                  axis.text.y = element_text(size = 20)) +
            theme(legend.position = "None") +
            scale_fill_brewer(palette = "Set2") +
    coord_flip()
```



```{r risc scores}
survey_fragments %>% 
    select(ASA.Class:POSPOM) %>% 
    # using dplyrs across function to perform columnwise operations on character data
    summarise(across(is.character, table)) %>% 
    .[2,] %>% 
    gather(risk_score, value) %>% 
    ggplot(aes(x = risk_score)) +
    geom_histogram()



            labs(x = "", 
                 y = "", 
                 title = "Which of the following Risc Scores do you routinely use?") +
            theme_light(base_size = 15) + 
            # theme(axis.title.x = element_text(size = 15, colour = 'black'),
            #       axis.title.y = element_text(size = 20, colour = 'black', angle = 90),
            #       title = element_text(size = 25, colour = 'black'),
            #       legend.position = "None") +
            theme(legend.position = "None") +
            scale_fill_brewer(palette = "Set2") + 
            ylim(0, max(df_for_scores$n) + 10)
```

